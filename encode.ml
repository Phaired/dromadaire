open Printf

(* Fonction pour convertir un caractère en chaîne binaire de 8 bits *)
let char_to_binary_string c =
  let n = Char.code c in
  let rec aux n acc count =
    if count = 8 then acc
    else aux (n lsr 1) ((string_of_int (n land 1)) ^ acc) (count + 1)
  in
  aux n "" 0

(* Fonction pour convertir une chaîne de caractères en chaîne binaire *)
let string_to_binary_string s =
  let rec aux chars acc =
    match chars with
    | [] -> acc
    | c::cs -> aux cs (acc ^ (char_to_binary_string c))
  in
  aux (String.to_seq s |> List.of_seq) ""

(* Fonction pour convertir un entier en chaîne binaire de 8 bits *)
let int_to_binary_string n =
  let rec aux n acc count =
    if count = 8 then acc
    else aux (n lsr 1) ((string_of_int (n land 1)) ^ acc) (count + 1)
  in
  aux n "" 0


(* Fonction pour lire l'entête PPM (P6) et retourner les dimensions et la valeur max de couleur *)
let lire_entete ic =
  ignore (input_line ic);  (* Ignore la ligne de type "P6" *)
  let dimensions = input_line ic in
  let (largeur, hauteur) = Scanf.sscanf dimensions "%d %d" (fun w h -> (w, h)) in
  let max_val = input_line ic in  (* Lit la valeur maximale des couleurs *)
  (largeur, hauteur, max_val)

(* Fonction pour convertir un entier en chaîne binaire de longueur fixe (30 bits ici) *)
let int_to_fixed_length_binary_string_30 n =
  let rec aux n acc count =
    if count = 30 then acc
    else aux (n lsr 1) ((string_of_int (n land 1)) ^ acc) (count + 1)
  in
  aux n "" 0

(* Fonction pour afficher les valeurs RGB d'un pixel en binaire *)
let afficher_pixel ic =
  let r = input_byte ic in
  let g = input_byte ic in
  let b = input_byte ic in
  printf "R: %s, G: %s, B: %s\n" (int_to_binary_string r) (int_to_binary_string g) (int_to_binary_string b)

(* Fonction pour écraser le dernier bit d'un octet avec un bit de message *)
let ecraser_dernier_bit octet bit_message =
  match bit_message with
  | '1' -> octet lor 1   (* Met le dernier bit à 1 *)
  | '0' -> octet land 0xFE (* Met le dernier bit à 0 *)
  | _ -> failwith "Le bit de message doit être '0' ou '1'"


(* Fonction pour convertir un entier en chaîne binaire de longueur fixe *)
let int_to_fixed_length_binary_string n length =
  let binary = int_to_binary_string n in
  String.make (length - String.length binary) '0' ^ binary

let inserer_message chemin_fichier message =
  let ic = open_in_bin chemin_fichier in
  let oc = open_out_bin "output.ppm" in
  let (largeur, hauteur, max_val) = lire_entete ic in
  Printf.fprintf oc "P6\n%d %d\n%s\n" largeur hauteur max_val;  (* Réécrit l'entête complète *)

  let taille_image = largeur * hauteur * 3 in  (* Calcule la taille de l'image *)
  let buffer = Bytes.create taille_image in  (* Crée un buffer de bytes mutable *)
  really_input ic buffer 0 taille_image;  (* Lit l'image dans le buffer *)

  let binary_message = string_to_binary_string message in
  let message_length = String.length binary_message in
  let binary_length = int_to_fixed_length_binary_string_30 message_length in
  let full_message = binary_length ^ binary_message in
  let message_index = ref 0 in

  for i = 0 to taille_image - 1 do
    if !message_index < String.length full_message then
      let octet = Char.code (Bytes.get buffer i) in
      let bit_message = full_message.[!message_index] in
      incr message_index;
      Bytes.set buffer i (Char.chr (ecraser_dernier_bit octet bit_message));
  done;

  output_bytes oc buffer;  (* Écrit le buffer modifié dans le fichier de sortie *)

  close_in ic;
  close_out oc
;;

(* Exemple d'utilisation *)
let () =
  let message = "2317637460346404933593423330597241144302990784407205300402957683433776274364661661947229842369990441072745302139221218813953230498219424226646680136941550262741190307045493444594891827449920079263702860425560345828325573441621469737961001532594468466504825288637756305808554374430751857079265290098339765803572477177818367045705239304298297379081872477089669583617329474338977458691735715925756707337050162032512774537763549587808127477857213994910946003976865134088537094290692829588993636366467768650947655509 4439148513599043508656394648393197978375884814509087115688205086257229828378880604995769269266809242160768372633423046578136755948454361965331681233264805062683310835261677843903281142933862883387255971819222620035030285917053843820782789885420491103531877614766924245264597732445974659521939537256370586836546049090035007408784886842146529835372989553751309029721263894005437513939385713967083464110854996734399144806543021531208454190191675409771660768375876609732524393653823160616130419837859150183907120977 4488837847969615899691489638309366228561068500090539223292972419773723117945931192690555543255596564552043504936928121510532413261974922997284473426765188040934187182788809577541428452394587811338332135197359024266297329334017950093868974748082330980477513242837168196967009885017013966524169960727188017924209334062058748052742942440796034727239426922035099421455466079357306320425935575498620278710830820201641978590610530670297013874215379373468780458112045899399012328964328325360658360908077219740359586256 1620366696992764873617156217044042072335661527971856126525908941859873039752076585853942520177442672040862611968487710382014151512960153682027194499089487247323002244176996272160610086875447568266772324232587324122936040811326590925862033550514191344452604259822535886063384556728263227716053234389599512085100901590546969815267920675752601346373704957978594428350566666315380407002697862470040453112960456905099809908285398026157964583713492806751696010679543615217912677960788248334928172400887118775017560663 491024146417485300727171912887308532911213303098470940338800745285072762089410770938612887110248991320907132740453598482034528709109034805053931708883705465323694798963979781114294398245760914960758043171678912166643797316080709924604289469701021387320937831643744787431520372511950728541473592537684784377594634384204343567810707057034726763569889646065220924837275000422001301795582897026188619750842433699796783841973241750349143315696760086104445484308275215936223115414474135818084323814141695743125296924 2133320753519759946046718508843136032688922115599440688674385461382516900366996601116697302982263031747929411460126945157517416678880397136050895828067188080080470446366896645006629098061392075542635371537964360353533152263903665380419800016714133753083559475791309306263850041498934895230246648633095425273249039525777820005542296247495318953627950247952700940964704358505152794320571896862201872432589706971228191823761221692064156417106884003908204987583616401624481135755281278766150630131135923699491222409 2308064468230126765625620137250612861457374759554700520784406414086282680584190517305859728799504928227148105720723761347177114576930938487159923855933729584956437553295962198138755941752408923715907625880454810043208525322491631651570049987370116361766079953934792828094201865764440701588845342426949415343267441406930613837366108458178311108429136449610973340547528345604752940486269663900400470419594624136077562318429698596958275839431693770859535499473120291639495129944454254961660701448195637033537160603 1118355213530925537282808343650423710192108332080282072587533338952880418772156621138563612242821033570839254716025415743947084508462092889449664086657328698064092887723996096765364779152103907456598964068452761816886404905128834439001835538044628545896704380953029437465974466487623990938637985597754843445238031888569781283322323213178430598910549707792144587235078670585924378941725635094569906428750922340263027797165421241652557085310567227220676350701534297072187364412217319888000355780854906641491662568 491024146417485300727171912887308532911213303098470940338800745285072762089410770938612887110248991320907132740453598482034528709109034805053931708883705465323694798963979781114294398245760914960758043171678912166643797316080709924604289469701021387320937831643744787431520372511950728541473592537684784377594634384204343567810707057034726763569889646065220924837275000422001301795582897026188619750842433699796783841973241750349143315696760086104445484308275215936223115414474135818084323814141695743125296924 4488837847969615899691489638309366228561068500090539223292972419773723117945931192690555543255596564552043504936928121510532413261974922997284473426765188040934187182788809577541428452394587811338332135197359024266297329334017950093868974748082330980477513242837168196967009885017013966524169960727188017924209334062058748052742942440796034727239426922035099421455466079357306320425935575498620278710830820201641978590610530670297013874215379373468780458112045899399012328964328325360658360908077219740359586256 4488837847969615899691489638309366228561068500090539223292972419773723117945931192690555543255596564552043504936928121510532413261974922997284473426765188040934187182788809577541428452394587811338332135197359024266297329334017950093868974748082330980477513242837168196967009885017013966524169960727188017924209334062058748052742942440796034727239426922035099421455466079357306320425935575498620278710830820201641978590610530670297013874215379373468780458112045899399012328964328325360658360908077219740359586256 5120951266341118920526798326285484992337893273707594982943522513121561765297941164981952365194693615654587498077483759882390272952423598089487157359922219943469437105357872175684846112471055511835263404484327280777500202967912545848457911327100265821074929009839951278081365717478008675666401723775580813596089632371633017087503964011537277738584740276689090490945949401796331263277685150787232415472890077273572258244949657899788062149663341845770446215482718289928714245429965555134672121609918273774669422018 1063290962213963451249969405661267700627269361470565365064410382686289545732697174766443882990155163274121819809939361208282872224959241712077422580050736027723597546750473984310656520922803259857773128540544571639427209204677429505902861136322125142278269997502713647696344790592915302510957766152777175087247462893065682738073595417298117198215948192102536104373308897422367657077222764625796731180800109221018579691477520872723546060173421113167019313265838633334968110577810266604219417611045355785002656556" in
  inserer_message "input.ppm" message
;;
